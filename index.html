<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>لوحة التحكم - المدير</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      /* Light Mode */
      --bg-color: #f0f2f5; --container-bg: rgba(255, 255, 255, 0.85); --text-color: #1c1e21; --header-color: #d32f2f; --accent-color: #c62828; --accent-rgb: 211, 47, 47; --accent-glow: rgba(var(--accent-rgb), 0.5); --input-bg: #ffffff; --input-border: #ccd0d5; --item-bg: #ffffff; --item-hover-bg: #f5f5f5; --shadow-color: rgba(0, 0, 0, 0.1);
    }
    [data-theme="dark"] {
      /* Dark Mode */
      --bg-color: #1a1a1a; --container-bg: rgba(22, 27, 34, 0.8); --text-color: #c9d1d9; --header-color: #f85149; --accent-color: #e53935; --accent-rgb: 248, 81, 73; --accent-glow: rgba(var(--accent-rgb), 0.5); --input-bg: #0d1117; --input-border: #30363d; --item-bg: #161b22; --item-hover-bg: #21262d; --shadow-color: rgba(0, 0, 0, 0.4);
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: 'Cairo', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; direction: rtl; transition: background-color 0.5s ease, color 0.5s ease; overflow: hidden; }
    body::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, var(--accent-glow) 0%, transparent 40%), radial-gradient(circle, var(--header-color) 0%, transparent 50%); background-size: 200% 200%; animation: aurora 20s linear infinite; z-index: -1; }
    @keyframes aurora { from { background-position: 0% 0%; } to { background-position: -200% -200%; } }
    .container { background: var(--container-bg); backdrop-filter: blur(15px) saturate(180%); -webkit-backdrop-filter: blur(15px) saturate(180%); padding: 30px 25px 120px 25px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); width: 100%; max-width: 600px; min-height: 95vh; max-height: 95vh; overflow-y: auto; box-shadow: 0 8px 32px 0 var(--shadow-color); display: flex; flex-direction: column; position: relative; }
    .header-icons { position: absolute; top: 20px; left: 25px; display: flex; gap: 15px; z-index: 100; }
    .icon-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--item-bg); border: 1px solid var(--input-border); color: var(--text-color); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; transition: all 0.3s ease; }
    .icon-btn:hover { transform: translateY(-3px) scale(1.1); color: var(--accent-color); box-shadow: 0 0 15px var(--accent-glow); }
    h1, h2 { text-align: center; margin-bottom: 25px; font-weight: 700; color: var(--header-color); text-shadow: 0 0 10px var(--accent-glow); }
    h2 { font-size: 1.3rem; }
    hr { border-top: 1px solid var(--input-border); margin: 25px 0; }
    button { width: 100%; padding: 14px 15px; margin-top: 10px; border: none; border-radius: 10px; font-size: 1.1rem; font-family: 'Cairo', sans-serif; font-weight: 700; background: linear-gradient(45deg, var(--accent-color), var(--header-color)); color: #fff; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px var(--shadow-color); }
    button:hover { transform: translateY(-3px); box-shadow: 0 6px 20px var(--accent-glow); }
    .list-item { background: var(--item-bg); padding: 15px; margin-bottom: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--input-border); box-shadow: 0 2px 5px var(--shadow-color); flex-wrap: wrap; }
    .list-item-content { flex-grow: 1; }
    .list-item button { width: auto; padding: 5px 10px; font-size: 0.8rem; margin: 0 0 0 10px; background: var(--danger-color); }
    section, .tab-content { animation: fadeIn 0.6s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .hidden { display: none !important; }
    .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: auto; display: flex; gap: 10px; padding: 10px; background: var(--container-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border-radius: 99px; border: 1px solid var(--input-border); box-shadow: 0 8px 32px 0 var(--shadow-color); z-index: 1000; transition: all 0.3s ease; }
    .nav-btn { display: flex; align-items: center; gap: 8px; padding: 10px 20px; background: transparent; border: none; color: var(--text-color); opacity: 0.7; border-radius: 99px; font-family: 'Cairo', sans-serif; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .nav-btn.active { opacity: 1; background: rgba(var(--accent-rgb), 0.15); color: var(--accent-color); box-shadow: 0 0 15px -5px var(--accent-glow); }
    .spinner { border: 4px solid var(--input-border); border-top: 4px solid var(--accent-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body data-theme="dark">
  <div class="container">
    <div class="header-icons">
      <!-- Icon is now for refreshing data -->
      <div id="refresh-icon" class="icon-btn" title="تحديث البيانات">
        <i class="fas fa-sync-alt"></i>
      </div>
    </div>
    
    <!-- No more login section -->

    <section id="dashboard-section">
      <h1>لوحة التحكم</h1>
      <hr />
      
      <div id="users-content" class="tab-content">
        <h2>المستخدمون المسجلون</h2>
        <h3><i class="fas fa-chalkboard-teacher"></i> المعلمون</h3>
        <div id="teachers-container"></div>
        <hr>
        <h3><i class="fas fa-user-graduate"></i> الطلاب</h3>
        <div id="students-container"></div>
      </div>
      
      <div id="tests-content" class="tab-content hidden">
        <h2>جميع الاختبارات</h2>
        <div id="all-tests-container"></div>
      </div>

      <div id="results-content" class="tab-content hidden">
        <h2>جميع النتائج</h2>
        <div id="all-results-container"></div>
      </div>
    </section>
  </div>
  
  <nav class="bottom-nav" id="bottom-nav">
    <button id="nav-users-btn" class="nav-btn active" data-target="users-content"><i class="fas fa-users"></i><span>المستخدمون</span></button>
    <button id="nav-tests-btn" class="nav-btn" data-target="tests-content"><i class="fas fa-file-alt"></i><span>الاختبارات</span></button>
    <button id="nav-results-btn" class="nav-btn" data-target="results-content"><i class="fas fa-poll-h"></i><span>النتائج</span></button>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
    import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";
    const firebaseConfig = { apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8", authDomain: "story-97cf7.firebaseapp.com", databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com", projectId: "story-97cf7", storageBucket: "story-97cf7.firebasestorage.app", messagingSenderId: "742801388214", appId: "1:742801388214:web:32a305a8057b0582c5ec17" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- DOM Elements ---
    const refreshIcon = document.getElementById('refresh-icon');
    const teachersContainer = document.getElementById("teachers-container");
    const studentsContainer = document.getElementById("students-container");
    const allTestsContainer = document.getElementById("all-tests-container");
    const allResultsContainer = document.getElementById("all-results-container");

    // --- UI Functions ---
    function showLoadingSpinner(container) { container.innerHTML = `<div class="spinner"></div>`; }
    const navButtons = document.querySelectorAll('.nav-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    navButtons.forEach(button => { button.addEventListener('click', () => { navButtons.forEach(btn => btn.classList.remove('active')); tabContents.forEach(content => content.classList.add('hidden')); button.classList.add('active'); document.getElementById(button.dataset.target).classList.remove('hidden'); }); });
    function setDefaultTab() { document.getElementById('nav-users-btn').click(); }

    // --- Data Loading Functions ---
    function loadAllData() {
        setDefaultTab();
        loadUsers();
        loadTests();
        loadResults();
    }
    
    function loadUsers() {
        showLoadingSpinner(teachersContainer);
        showLoadingSpinner(studentsContainer);
        // Load Teachers
        onValue(ref(db, 'users'), (snapshot) => {
            teachersContainer.innerHTML = "";
            if(snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    renderItem(teachersContainer, `<strong>${childSnapshot.key}</strong> | المرور: ${childSnapshot.val().password}`, `users/${childSnapshot.key}`);
                });
            } else { teachersContainer.innerHTML = "<p>لا يوجد معلمون مسجلون.</p>"; }
        }, { onlyOnce: true }); // Fetch data once
        // Load Students
        onValue(ref(db, 'students'), (snapshot) => {
            studentsContainer.innerHTML = "";
            if(snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    renderItem(studentsContainer, `<strong>${childSnapshot.key}</strong> | المرور: ${childSnapshot.val().password}`, `students/${childSnapshot.key}`);
                });
            } else { studentsContainer.innerHTML = "<p>لا يوجد طلاب مسجلون.</p>"; }
        }, { onlyOnce: true });
    }
    
    function loadTests() {
        showLoadingSpinner(allTestsContainer);
        onValue(ref(db, 'tests'), (snapshot) => {
            allTestsContainer.innerHTML = "";
            if(snapshot.exists()) {
                snapshot.forEach(teacherSnapshot => {
                    teacherSnapshot.forEach(testSnapshot => {
                        const test = testSnapshot.val();
                        const text = `<strong>${test.name}</strong> (${test.grade})<br><small>المعلم: ${teacherSnapshot.key}</small>`;
                        renderItem(allTestsContainer, text, `tests/${teacherSnapshot.key}/${testSnapshot.key}`);
                    });
                });
            } else { allTestsContainer.innerHTML = "<p>لا توجد اختبارات.</p>"; }
        }, { onlyOnce: true });
    }
    
    function loadResults() {
        showLoadingSpinner(allResultsContainer);
        onValue(ref(db, 'studentResults'), (snapshot) => {
            allResultsContainer.innerHTML = "";
            if(snapshot.exists()) {
                snapshot.forEach(studentSnapshot => {
                    studentSnapshot.forEach(resultSnapshot => {
                        const result = resultSnapshot.val();
                        const text = `الطالب: <strong>${studentSnapshot.key}</strong><br>الاختبار: ${result.testName}<br>الدرجة: ${result.score}`;
                        renderItem(allResultsContainer, text, `studentResults/${studentSnapshot.key}/${resultSnapshot.key}`, true); // Can now delete results
                    });
                });
            } else { allResultsContainer.innerHTML = "<p>لا توجد نتائج.</p>"; }
        }, { onlyOnce: true });
    }
    
    function renderItem(container, text, dbPath, showDelete = true) {
        const div = document.createElement('div');
        div.className = 'list-item';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'list-item-content';
        contentDiv.innerHTML = text;
        div.appendChild(contentDiv);
        
        if (showDelete) {
            const button = document.createElement('button');
            button.innerHTML = '<i class="fas fa-trash"></i>';
            button.onclick = () => {
                if (confirm(`هل أنت متأكد من حذف هذا العنصر؟`)) {
                    remove(ref(db, dbPath))
                        .then(() => {
                            alert("تم الحذف بنجاح.");
                            loadAllData(); // Reload all data to reflect changes
                        })
                        .catch((error) => alert("خطأ في الحذف: " + error));
                }
            };
            div.appendChild(button);
        }
        container.appendChild(div);
    }
    
    // --- Event Listeners ---
    refreshIcon.onclick = () => {
        const icon = refreshIcon.querySelector('i');
        icon.classList.add('fa-spin'); // Add spinning animation
        loadAllData();
        // Remove spinning animation after a short delay
        setTimeout(() => icon.classList.remove('fa-spin'), 1000);
    };
    
    // --- Init on load ---
    window.onload = () => {
        loadAllData();
    };
  </script>
</body>
</html>
